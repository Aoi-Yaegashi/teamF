## 3.2. 機能詳細
各主要機能について、機能詳細をシーケンス図にて図示する。

  ### 3.2.1 商品閲覧・購入機能（購入者向け）

   #### 3.2.1.1 トップページ表示機能（F01）
   <div class="mermaid">
   sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant TPC as TopPageController
    participant TPS as TopPageService
    participant CatRepo as CategoryRepository
    participant ProdRepo as ProductRepository
    participant BanRepo as BannerRepository

    %% ユーザーがトップページにアクセス
    User->>FE: トップページアクセス

    %% フロントエンドがAPI呼び出し
    FE->>TPC: GET /api/top-page

    %% コントローラがサービスに処理を依頼
    TPC->>TPS: getTopPageData()

    %% サービスがカテゴリ一覧を取得
    TPS->>CatRepo: getCategories()
    CatRepo-->>TPS: カテゴリ一覧

    %% サービスが新着商品を取得（任意）
    TPS->>ProdRepo: getNewProducts()
    ProdRepo-->>TPS: 新着商品一覧

    %% サービスがバナーを取得（任意）
    TPS->>BanRepo: getActiveBanners()
    BanRepo-->>TPS: バナー一覧

    %% サービスがデータをまとめてコントローラに返却
    TPS-->>TPC: {カテゴリ一覧, 新着商品, バナー}

    %% コントローラがフロントエンドにレスポンス
    TPC-->>FE: レスポンス（カテゴリ一覧・新着商品・バナー）

    %% フロントエンドが画面に反映
    FE->>User: 商品カテゴリ一覧・新着商品・バナーを画面に表示
</div>

   #### 3.2.1.2 商品一覧・カテゴリ別の商品閲覧機能（F02） 
   <div class="mermaid">
   sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant PLC as ProductListController
    participant PLS as ProductListService
    participant ProdRepo as ProductRepository
    participant CatRepo as CategoryRepository

    %% ユーザーが商品一覧ページにアクセス（カテゴリ選択や検索）
    User->>FE: 商品一覧ページ表示（カテゴリ選択・検索）

    %% フロントエンドがAPI呼び出し
    FE->>PLC: GET /api/products

    %% コントローラがサービスに処理を依頼
    PLC->>PLS: getProductList(category_id, keyword)

    %% サービスがカテゴリ情報を取得（カテゴリ名表示用、必要に応じて）
    PLS->>CatRepo: getCategory(category_id)
    CatRepo-->>PLS: カテゴリ情報

    %% サービスが商品一覧を取得
    PLS->>ProdRepo: findProducts(category_id, keyword)
    ProdRepo-->>PLS: 商品一覧データ

    %% サービスがデータを整形してコントローラに返却
    PLS-->>PLC: 商品一覧データ（商品ID、商品名、価格、画像URL、在庫数など）

    %% コントローラがフロントエンドにレスポンス
    PLC-->>FE: 商品一覧レスポンス

    %% フロントエンドが画面に反映
    FE->>User: 商品リストを表示（画像・商品名・価格など）
</div>

   #### 3.2.1.3 商品詳細ページの表示機能（F03）
   <div class="mermaid">
sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant PDC as ProductDetailController
    participant PDS as ProductDetailService
    participant ProdRepo as ProductRepository

    %% ユーザーが商品詳細ページを表示
    User->>FE: 商品詳細ページ表示（商品選択）

    %% フロントエンドがAPI呼び出し
    FE->>PDC: GET /api/products/{product_id}

    %% コントローラがサービスに処理を依頼
    PDC->>PDS: getProductDetail(product_id)

    %% サービスが商品リポジトリに問い合わせ
    PDS->>ProdRepo: findProductById(product_id)
    ProdRepo-->>PDS: 商品データ or null

    %% サービスで商品状態を判定
    alt 商品データあり
        alt 公開中かつ販売中
            alt 在庫あり
                PDS-->>PDC: 商品詳細データ（在庫あり）
                PDC-->>FE: 商品詳細レスポンス
                FE->>User: 商品詳細表示（写真・価格・説明・素材・在庫数など）
            else 在庫なし
                PDS-->>PDC: 商品詳細データ（在庫なし）
                PDC-->>FE: 商品詳細レスポンス（在庫なし表示）
                FE->>User: 商品詳細表示（在庫なし）
            end
        else 非公開または販売終了
            PDS-->>PDC: エラー（非公開/販売終了）
            PDC-->>FE: エラーレスポンス（非公開/販売終了）
            FE->>User: エラーメッセージ表示（非公開/販売終了）
        end
    else 商品データなし
        PDS-->>PDC: エラー（商品なし）
        PDC-->>FE: エラーレスポンス（商品なし）
        FE->>User: エラーメッセージ表示（商品が存在しません）
    end
</div>

   #### 3.2.1.4 商品のカート追加機能（F03）
   <div class="mermaid">
   sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant Session as セッション管理（Cart）
    participant CartC as CartController
    participant CartS as CartService
    participant CartRepo as CartRepository
    participant CartItemRepo as CartItemRepository
    participant ProdRepo as ProductRepository

    %% 1. ユーザーが「カートに追加」ボタンを押す
    User->>FE: カートに追加ボタン押下

    %% 2. フロントエンドがCartセッション（セッションIDまたはユーザID）を取得
    FE->>Session: Cartセッション取得
    Session-->>FE: セッションIDまたはユーザID

    %% 3. フロントエンドがAPI呼び出し
    FE->>CartC: POST /api/cart/add { product_id, quantity, session_id or user_id }

    %% 4. コントローラがサービスに処理を依頼
    CartC->>CartS: addProductToCart(session_id or user_id, product_id, quantity)

    %% 5. サービスが商品情報を取得（在庫チェックのため）
    CartS->>ProdRepo: getProductById(product_id)
    ProdRepo-->>CartS: 商品情報（在庫数含む）

    %% 6. サービスが在庫チェック
    alt 在庫不足
        CartS-->>CartC: エラー（在庫不足）
        CartC-->>FE: エラーレスポンス（在庫不足）
        FE->>User: エラーメッセージ表示（在庫不足）
    else 在庫あり
        %% 7. サービスがCartセッションで既存カートの有無を確認
        CartS->>CartRepo: findCartBySessionOrUser(session_id, user_id)
        alt 既存カートあり
            CartRepo-->>CartS: カート情報
        else 既存カートなし
            CartRepo-->>CartS: null
            %% 新規カートを作成し、Cartセッションに保存
            CartS->>CartRepo: createCart(session_id, user_id)
            CartRepo-->>CartS: 新規カート情報
            CartS->>Session: Cartセッション更新（新規カートID保存）
        end

        %% 8. サービスがカートアイテムの有無を確認
        CartS->>CartItemRepo: getCartItem(cart_id, product_id)
        alt 既存アイテムあり
            CartItemRepo-->>CartS: カートアイテム情報
            %% 数量加算
            CartS->>CartItemRepo: updateCartItemQuantity(cart_item_id, quantity)
            CartItemRepo-->>CartS: 更新後カートアイテム
        else 既存アイテムなし
            CartItemRepo-->>CartS: null
            %% 新規アイテム追加
            CartS->>CartItemRepo: addCartItem(cart_id, product_id, quantity)
            CartItemRepo-->>CartS: 新規カートアイテム
        end

        %% 9. サービスが最新カート内容を取得
        CartS->>CartItemRepo: getCartItems(cart_id)
        CartItemRepo-->>CartS: カートアイテム一覧

        %% 10. サービスがコントローラに返却
        CartS-->>CartC: { success: true, cart_items }

        %% 11. コントローラがフロントエンドにレスポンス
        CartC-->>FE: { success: true, cart_items }

        %% 12. フロントエンドがカートページに反映
        FE->>User: カート内容を画面に表示
    end
</div>

   #### 3.2.1.5 カート内商品の一覧、数量、小計、合計金額の表示機能（F04）
   **１．カートページ表示機能**
<div class="mermaid">
sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant CartC as CartController
    participant CartS as CartService
    participant CartRepo as CartRepository
    participant CartItemRepo as CartItemRepository
    participant ProdRepo as ProductRepository

    %% ユーザーがカートページを表示
    User->>FE: カートページ表示

    %% フロントエンドがAPI呼び出し
    FE->>CartC: GET /api/cart

    %% コントローラがサービスに処理を依頼
    CartC->>CartS: getCart(user_id or session_id)

    %% サービスがカート情報を取得
    CartS->>CartRepo: findCartByUser(user_id or session_id)
    CartRepo-->>CartS: カート情報

    %% サービスがカートアイテム一覧を取得
    CartS->>CartItemRepo: getCartItems(cart_id)
    CartItemRepo-->>CartS: カートアイテム一覧

    %% サービスが各カートアイテムの商品情報を取得
    loop カートアイテムごと
        CartS->>ProdRepo: getProductById(product_id)
        ProdRepo-->>CartS: 商品情報（商品名・価格・画像URL等）
    end

    %% サービスが小計・合計金額を計算し、一覧データを生成
    CartS-->>CartC: カート一覧データ（商品名・画像・単価・数量・小計・合計金額）

    %% コントローラがフロントエンドに返却
    CartC-->>FE: カート一覧レスポンス

    %% フロントエンドが画面に反映
    FE->>User: カート一覧を表示（数量変更・削除ボタン、合計金額含む）

    %% 商品情報が取得できない場合
    alt 商品情報取得失敗
        CartS-->>CartC: エラー（商品情報なし）
        CartC-->>FE: エラーレスポンス
        FE->>User: エラーメッセージ表示
    end
</div>

**２．カート商品追加機能**
<div class="mermaid">
sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant CartC as CartController
    participant CartS as CartService
    participant CartRepo as CartRepository
    participant CartItemRepo as CartItemRepository
    participant ProdRepo as ProductRepository

    %% 1. ユーザーがカート画面で数量入力欄を編集し「更新」ボタンを押す
    User->>FE: 数量変更（追加）操作

    %% 2. フロントエンドがAPI呼び出し
    FE->>CartC: GET /api/cart { cart_item_id, quantity }

    %% 3. コントローラがサービスに処理を依頼
    CartC->>CartS: updateCartItemQuantity(cart_item_id, quantity)

    %% 4. サービスがカートアイテムを取得
    CartS->>CartItemRepo: getCartItemById(cart_item_id)
    CartItemRepo-->>CartS: カートアイテム情報（cart_id, product_id, 現在数量）

    %% 5. サービスが商品情報を取得（在庫チェックのため）
    CartS->>ProdRepo: getProductById(product_id)
    ProdRepo-->>CartS: 商品情報（在庫数含む）

    %% 6. サービスが在庫チェック
    alt 在庫不足
        CartS-->>CartC: エラー（在庫不足）
        CartC-->>FE: エラーレスポンス（在庫不足）
        FE->>User: エラーメッセージ表示（在庫不足）
    else 在庫あり
        %% 7. サービスがカートアイテムの数量を更新
        CartS->>CartItemRepo: updateQuantity(cart_item_id, quantity)
        CartItemRepo-->>CartS: 更新後カートアイテム

        %% 8. サービスが最新カート内容を取得
        CartS->>CartItemRepo: getCartItems(cart_id)
        CartItemRepo-->>CartS: カートアイテム一覧

        %% 9. サービスが各カートアイテムの商品情報を取得し小計・合計を計算
        loop カートアイテムごと
            CartS->>ProdRepo: getProductById(product_id)
            ProdRepo-->>CartS: 商品情報（商品名・価格・画像URL等）
        end

        %% 10. サービスがコントローラに返却
        CartS-->>CartC: { success: true, updated_cart }

        %% 11. コントローラがフロントエンドにレスポンス
        CartC-->>FE: { success: true, updated_cart }

        %% 12. フロントエンドが画面に反映
        FE->>User: カート内容を画面に表示（数量・小計・合計も更新）
    end
</div>

**３．カート商品削除機能**
上記について、DELETE /api/cartで実行。

   #### 3.2.1.6 注文確定処理機能

**１．注文手続きページ表示機能（F05）**
<div class="mermaid">
sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant CartC as CartController
    participant CartS as CartService
    participant CartRepo as CartRepository
    participant CartItemRepo as CartItemRepository
    participant ProdRepo as ProductRepository

    %% ユーザーが「購入手続き」ページを表示
    User->>FE: 購入手続きページ表示

    %% フロントエンドがAPI呼び出し
    FE->>CartC: POST /api/cart/checkout { session_id or user_id }

    %% コントローラがサービスに処理を依頼
    CartC->>CartS: getCartForCheckout(session_id or user_id)

    %% サービスがカート情報を取得
    CartS->>CartRepo: findCartBySessionOrUser(session_id, user_id)
    CartRepo-->>CartS: カート情報

    %% サービスがカートアイテム一覧を取得
    CartS->>CartItemRepo: getCartItems(cart_id)
    CartItemRepo-->>CartS: [cart_item1, cart_item2, ...]

    %% サービスが1つめのカートアイテムの商品情報を取得し在庫チェック
    CartS->>ProdRepo: getProductById(cart_item1.product_id)
    ProdRepo-->>CartS: 商品情報1（在庫数含む）

    %% サービスが2つめのカートアイテムの商品情報を取得し在庫チェック
    CartS->>ProdRepo: getProductById(cart_item2.product_id)
    ProdRepo-->>CartS: 商品情報2（在庫数含む）

    %% （カートアイテムがさらにあれば同様に記述）

    %% 在庫OKの場合、購入予定カート情報をまとめて返却
    CartS-->>CartC: 購入予定カート情報（商品名・画像・単価・数量・小計・合計金額）

    %% コントローラがフロントエンドに返却
    CartC-->>FE: 購入予定カート情報

    %% フロントエンドが購入フォームを表示
    FE->>User: 購入フォームを表示
</div>

**２．注文確認画面表示機能（F06）**
<div class="mermaid">
sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant OrderC as OrderController
    participant OrderS as OrderService
    participant ProdRepo as ProductRepository

    %% 1. ユーザーが注文確認画面を表示
    User->>FE: 注文確認画面表示

    %% 2. フロントエンドがAPI呼び出し
    FE->>OrderC: POST /api/orders/preview { shipping_address, payment_method, cart_items }

    %% 3. コントローラがサービスに処理を依頼
    OrderC->>OrderS: previewOrder(shipping_address, payment_method, cart_items)

    %% 4. サービスが各カートアイテムの商品情報を取得し金額計算
    OrderS->>ProdRepo: getProductById(cart_item1.product_id)
    ProdRepo-->>OrderS: 商品情報1（価格等）
    OrderS->>ProdRepo: getProductById(cart_item2.product_id)
    ProdRepo-->>OrderS: 商品情報2（価格等）
    %% 必要なカートアイテム数だけ繰り返し

    %% 5. サービスが合計金額等を計算
    OrderS-->>OrderC: 計算結果（合計金額、送料、税金等）

    %% 6. コントローラがフロントエンドに返却
    OrderC-->>FE: 計算結果（合計金額等）

    %% 7. フロントエンドが確認画面を表示
    FE->>User: 確認画面を表示
</div>

**３．注文確定機能（F06）**
   <div class="mermaid">
sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant OrderC as OrderController
    participant OrderS as OrderService
    participant ProdRepo as ProductRepository
    participant OrderRepo as OrderRepository
    participant OrderItemRepo as OrderItemRepository
    participant CartRepo as CartRepository
    participant CartItemRepo as CartItemRepository
    participant MailS as MailService

    %% 1. ユーザーが注文確定ボタンを押す
    User->>FE: 注文確定

    %% 2. フロントエンドがAPI呼び出し
    FE->>OrderC: POST /api/orders { customer_info, shipping_address, payment_method, cart_items }

    %% 3. コントローラがサービスに処理を依頼
    OrderC->>OrderS: createOrder(customer_info, shipping_address, payment_method, cart_items)

    %% 4. サービスが各カートアイテムの商品情報を取得し在庫チェック
    OrderS->>ProdRepo: getProductById(cart_item1.product_id)
    ProdRepo-->>OrderS: 商品情報1（在庫数含む）
    OrderS->>ProdRepo: getProductById(cart_item2.product_id)
    ProdRepo-->>OrderS: 商品情報2（在庫数含む）
    %% 必要なカートアイテム数だけ繰り返し

    %% 5. サービスが全商品の在庫をチェック
    alt 在庫不足
        OrderS-->>OrderC: エラー（在庫不足）
        OrderC-->>FE: エラーレスポンス（在庫不足）
        FE->>User: エラーメッセージ表示（在庫不足）
    else 在庫あり
        %% 6. サービスが在庫を減算
        OrderS->>ProdRepo: decreaseStock(product_id, quantity)
        %% 各商品分繰り返し

        %% 7. サービスが注文データを登録
        OrderS->>OrderRepo: insertOrder(customer_info, shipping_address, payment_method, 合計金額, etc)
        OrderRepo-->>OrderS: order_id, order_number

        %% 8. サービスが注文明細データを登録
        OrderS->>OrderItemRepo: insertOrderItems(order_id, cart_items)
        OrderItemRepo-->>OrderS: 注文明細登録完了

        %% 9. サービスがカート内容をクリア
        OrderS->>CartRepo: findCartBySessionOrUser(customer_info.session_id, customer_info.user_id)
        CartRepo-->>OrderS: カート情報
        OrderS->>CartItemRepo: deleteCartItems(cart_id)
        CartItemRepo-->>OrderS: カートアイテム削除完了

        %% 10. サービスが確認メールを送信
        OrderS->>MailS: sendOrderConfirmation(customer_info.email, order_id)
        MailS-->>OrderS: メール送信完了

        %% 11. サービスが注文ID等を返却
        OrderS-->>OrderC: { order_id, order_number, payment_status }

        %% 12. コントローラがフロントエンドに返却
        OrderC-->>FE: { order_id, order_number, payment_status }

        %% 13. フロントエンドが購入完了ページへ遷移
        FE->>User: 購入完了ページ表示
    end
</div>

   #### 3.2.1.7 注文完了後の確認メール自動送信機能
**１．メール送信機能（任意）**
   <div class="mermaid">
   sequenceDiagram
    participant User as ユーザー
    participant Browser as フロントエンド
    participant OrderController as OrderController
    participant OrderService as OrderService
    participant OrderRepo as OrderRepository
    participant CartRepo as CartRepository
    participant ProductRepo as ProductRepository
    participant MailService as MailService
    participant DB as データベース
    participant MailServer as メールサーバ

    User->>Browser: 注文確定ボタン押下
    Browser->>OrderController: POST /api/orders { order_id }
    OrderController->>OrderService: createOrder{ user_id, order_id }
    OrderService->>CartRepo: findByUserId{ user_id }
    CartRepo->>DB: カートデータ取得
    DB-->>CartRepo: カートデータ返却
    CartRepo-->>OrderService: Cartエンティティ返却
    loop カート内全商品
        OrderService->>ProductRepo: findById{ product_id }
        ProductRepo->>DB: 商品データ取得
        DB-->>ProductRepo: 商品データ返却
        ProductRepo-->>OrderService: Productエンティティ返却
    end
    OrderService->>OrderRepo: save(Order)
    OrderRepo->>DB: 注文データ保存
    DB-->>OrderRepo: 保存結果返却
    OrderRepo-->>OrderService: Orderエンティティ返却
    OrderService->>MailService: sendOrderConfirmationMail(ユーザー, 注文内容)
    MailService->>MailServer: メール送信
    MailServer-->>MailService: 送信結果返却
    MailService-->>OrderService: 送信結果返却
    OrderService-->>OrderController: 注文完了レスポンス返却
    OrderController-->>Browser: 注文完了レスポンス返却
    Browser-->>User: 注文完了画面表示
</div>

**２．注文完了ページ表示機能（F07）**
<div class="mermaid">
sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant OrderC as OrderController
    participant OrderS as OrderService
    participant OrderRepo as OrderRepository
    participant OrderItemRepo as OrderItemRepository

    %% 1. ユーザーが注文完了ページを表示
    User->>FE: 注文完了ページ表示（order_id指定）

    %% 2. フロントエンドがAPI呼び出し
    FE->>OrderC: GET /api/orders/{order_id}

    %% 3. コントローラがサービスに処理を依頼
    OrderC->>OrderS: getOrderDetail(order_id)

    %% 4. サービスが注文情報を取得
    OrderS->>OrderRepo: findOrderById(order_id)
    OrderRepo-->>OrderS: 注文情報（ユーザー・合計金額・配送先・ステータス等）

    %% 5. サービスが注文明細を取得
    OrderS->>OrderItemRepo: findOrderItemsByOrderId(order_id)
    OrderItemRepo-->>OrderS: 注文明細一覧（商品名・数量・単価等）

    %% 6. サービスが注文情報＋明細をまとめて返却
    OrderS-->>OrderC: 注文情報（明細含む）

    %% 7. コントローラがフロントエンドに返却
    OrderC-->>FE: 注文情報

    %% 8. フロントエンドが注文完了画面を表示
    FE->>User: 注文完了画面を表示
</div>

  #### 3.2.2 商品検索機能（購入者向け）

   ##### 3.2.2.1 単語検索機能
   <div class="mermaid">
   sequenceDiagram
    participant User as ユーザー
    participant Browser as フロントエンド
    participant SearchController as ProductSearchController
    participant SearchService as ProductSearchService
    participant ProductRepo as ProductRepository
    participant DB as データベース

    User->>Browser: 検索ワード入力し検索ボタン押下
    Browser->>SearchController: GET /api/products/search?keyword=XXX
    SearchController->>SearchService: searchProducts(keyword)
    SearchService->>ProductRepo: searchByKeyword(keyword)
    ProductRepo->>DB: 商品名・説明文 LIKE検索（%keyword%）
    DB-->>ProductRepo: 検索結果データ返却
    ProductRepo-->>SearchService: Productエンティティリスト返却
    SearchService-->>SearchController: 商品DTOリスト返却
    SearchController-->>Browser: 検索結果JSON返却
    Browser-->>User: 検索結果画面表示
</div>

  ### 3.2.3 配送料金設定・計算機能（管理者向け）

   #### 3.2.3.1 送料設定機能
**1. 送料設定機能**
<div class="mermaid">
sequenceDiagram
    participant AdminUser as 管理者
    participant Browser as 管理画面
    participant ShippingFeeController as ShippingFeeController
    participant ShippingFeeService as ShippingFeeService
    participant ShippingFeeRepo as ShippingFeeRepository
    participant DB as データベース

    AdminUser->>Browser: 送料設定画面を開く
    Browser->>ShippingFeeController: GET /api/admin/shipping-fee
    ShippingFeeController->>ShippingFeeService: getShippingFeeSettings()
    ShippingFeeService->>ShippingFeeRepo: findAll()
    ShippingFeeRepo->>DB: 送料設定データ取得
    DB-->>ShippingFeeRepo: 送料設定データ返却
    ShippingFeeRepo-->>ShippingFeeService: 送料設定リスト返却
    ShippingFeeService-->>ShippingFeeController: 送料設定DTO返却
    ShippingFeeController-->>Browser: 送料設定データJSON返却
    AdminUser->>Browser: 送料条件を入力し保存
    Browser->>ShippingFeeController: POST /api/admin/shipping-fee {送料条件}
    ShippingFeeController->>ShippingFeeService: saveShippingFee(送料条件)
    ShippingFeeService->>ShippingFeeRepo: saveOrUpdate(送料条件)
    ShippingFeeRepo->>DB: 送料設定データ保存
    DB-->>ShippingFeeRepo: 保存結果返却
    ShippingFeeRepo-->>ShippingFeeService: 保存済み送料エンティティ返却
    ShippingFeeService-->>ShippingFeeController: 保存結果返却
    ShippingFeeController-->>Browser: 保存結果JSON返却
</div>

**2. 送料計算機能**
<div class="mermaid">
sequenceDiagram
    participant User as 購入者
    participant Browser as フロントエンド
    participant OrderController as OrderController
    participant OrderService as OrderService
    participant ShippingFeeService as ShippingFeeService
    participant ShippingFeeRepo as ShippingFeeRepository
    participant DB as データベース

    User->>Browser: 注文確認画面を開く
    Browser->>OrderController: GET /api/orders/preview?address=XX&cart=YY
    OrderController->>OrderService: previewOrder(ユーザーID, 配送先, カート内容)
    OrderService->>ShippingFeeService: calculateShippingFee(配送先, カート内容)
    ShippingFeeService->>ShippingFeeRepo: findApplicableFee(配送先, カート金額)
    ShippingFeeRepo->>DB: 送料設定データ取得
    DB-->>ShippingFeeRepo: 送料設定データ返却
    ShippingFeeRepo-->>ShippingFeeService: 適用送料返却
    ShippingFeeService-->>OrderService: 送料金額返却
    OrderService-->>OrderController: プレビュー情報（送料含む）返却
    OrderController-->>Browser: プレビュー情報JSON返却
    Browser-->>User: 注文確認画面に送料を表示
</div>

   #### 3.2.3.2 配送方法の表示・選択機能（Cloud）
   <div class="mermaid">
sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant DeliveryMethodController as DeliveryMethodController
    participant DeliveryMethodService as DeliveryMethodService
    participant DeliveryMethodRepo as DeliveryMethodRepository
    participant DB as データベース

    AdminUser->>AdminBrowser: 配送方法設定画面を開く
    AdminBrowser->>DeliveryMethodController: GET /api/admin/delivery-methods
    DeliveryMethodController->>DeliveryMethodService: getDeliveryMethods()
    DeliveryMethodService->>DeliveryMethodRepo: findAll()
    DeliveryMethodRepo->>DB: 配送方法データ取得
    DB-->>DeliveryMethodRepo: 配送方法データ返却
    DeliveryMethodRepo-->>DeliveryMethodService: 配送方法リスト返却
    DeliveryMethodService-->>DeliveryMethodController: 配送方法DTO返却
    DeliveryMethodController-->>AdminBrowser: 配送方法データJSON返却
    AdminUser->>AdminBrowser: 配送方法を入力し保存
    AdminBrowser->>DeliveryMethodController: POST /api/admin/delivery-methods {配送方法情報}
    DeliveryMethodController->>DeliveryMethodService: saveDeliveryMethod(配送方法情報)
    DeliveryMethodService->>DeliveryMethodRepo: saveOrUpdate(配送方法情報)
    DeliveryMethodRepo->>DB: 配送方法データ保存
    DB-->>DeliveryMethodRepo: 保存結果返却
    DeliveryMethodRepo-->>DeliveryMethodService: 保存済み配送方法エンティティ返却
    DeliveryMethodService-->>DeliveryMethodController: 保存結果返却
    DeliveryMethodController-->>AdminBrowser: 保存結果JSON返却
</div>


  ### 3.2.4 商品管理機能（管理者向け）

   #### 3.2.4.1 商品登録・編集機能（商品名・価格・説明・画像など）
**1. 商品登録機能**
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant ProductController as ProductController
    participant ProductService as ProductService
    participant ImageStorageService as ImageStorageService
    participant ProductRepo as ProductRepository
    participant DB as データベース
    participant Storage as 画像ストレージ

    AdminUser->>AdminBrowser: 商品登録画面を開く
    AdminBrowser->>ProductController: POST /api/admin/products {商品名, 価格, 説明, 画像ファイル}
    ProductController->>ProductService: createProduct(商品情報, 画像ファイル)
    ProductService->>ImageStorageService: uploadImage(画像ファイル)
    ImageStorageService->>Storage: 画像ファイル保存
    Storage-->>ImageStorageService: 画像URL返却
    ImageStorageService-->>ProductService: 画像URL返却
    ProductService->>ProductRepo: save(Productエンティティ(画像URL含む))
    ProductRepo->>DB: 商品データ保存
    DB-->>ProductRepo: 保存結果返却
    ProductRepo-->>ProductService: 保存済みエンティティ返却
    ProductService-->>ProductController: 商品DTO返却
    ProductController-->>AdminBrowser: 登録結果JSON返却
</div>

**2. 商品編集機能**
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant ProductController as ProductController
    participant ProductService as ProductService
    participant ImageStorageService as ImageStorageService
    participant ProductRepo as ProductRepository
    participant DB as データベース
    participant Storage as 画像ストレージ

    AdminUser->>AdminBrowser: 商品編集画面を開く
    AdminBrowser->>ProductController: PUT /api/admin/products/{商品ID} {商品名, 価格, 説明, 画像ファイル（任意）}
    ProductController->>ProductService: updateProduct(商品ID, 商品情報, 画像ファイル)
    ProductService->>ProductRepo: findById(商品ID)
    ProductRepo->>DB: 商品データ取得
    DB-->>ProductRepo: 商品データ返却
    ProductRepo-->>ProductService: Productエンティティ返却
    alt 画像ファイルが新規の場合
        ProductService->>ImageStorageService: uploadImage(新画像ファイル)
        ImageStorageService->>Storage: 画像ファイル保存
        Storage-->>ImageStorageService: 新画像URL返却
        ImageStorageService-->>ProductService: 新画像URL返却
        ProductService->>ImageStorageService: deleteImage(旧画像URL)
        ImageStorageService->>Storage: 旧画像削除
        Storage-->>ImageStorageService: 削除完了
    end
    ProductService->>ProductRepo: save(更新済Productエンティティ)
    ProductRepo->>DB: 商品データ更新
    DB-->>ProductRepo: 更新結果返却
    ProductRepo-->>ProductService: 更新済みエンティティ返却
    ProductService-->>ProductController: 商品DTO返却
    ProductController-->>AdminBrowser: 編集結果JSON返却
</div>

   #### 3.2.4.2 商品削除機能
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant ProductController as ProductController
    participant ProductService as ProductService
    participant ProductRepo as ProductRepository
    participant ImageStorageService as ImageStorageService
    participant DB as データベース
    participant Storage as 画像ストレージ

    AdminUser->>AdminBrowser: 商品一覧画面で削除ボタン押下
    AdminBrowser->>ProductController: DELETE /api/admin/products/{商品ID}
    ProductController->>ProductService: deleteProduct(商品ID)
    ProductService->>ProductRepo: findById(商品ID)
    ProductRepo->>DB: 商品データ取得
    DB-->>ProductRepo: 商品データ返却
    ProductRepo-->>ProductService: Productエンティティ返却
    alt 画像ファイルが存在する場合
        ProductService->>ImageStorageService: deleteImage(画像URL)
        ImageStorageService->>Storage: 画像ファイル削除
        Storage-->>ImageStorageService: 削除完了
    end
    alt 論理削除の場合
        ProductService->>ProductRepo: markAsDeleted(商品ID)
        ProductRepo->>DB: is_deletedフラグ更新
        DB-->>ProductRepo: 更新結果返却
    else 物理削除の場合
        ProductService->>ProductRepo: delete(商品ID)
        ProductRepo->>DB: 商品データ削除
        DB-->>ProductRepo: 削除結果返却
    end
    ProductRepo-->>ProductService: 削除完了返却
    ProductService-->>ProductController: 削除完了レスポンス
    ProductController-->>AdminBrowser: 削除結果JSON返却
</div>

   #### 3.2.4.3 商品の在庫管理機能（在庫数の更新）
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant InventoryController as InventoryController
    participant InventoryService as InventoryService
    participant ProductRepo as ProductRepository
    participant InventoryRepo as InventoryRepository
    participant DB as データベース

    AdminUser->>AdminBrowser: 商品一覧画面で在庫編集ボタン押下
    AdminBrowser->>InventoryController: PUT /api/admin/products/{商品ID}/inventory {新在庫数}
    InventoryController->>InventoryService: updateInventory(商品ID, 新在庫数)
    InventoryService->>ProductRepo: findById(商品ID)
    ProductRepo->>DB: 商品データ取得
    DB-->>ProductRepo: 商品データ返却
    ProductRepo-->>InventoryService: Productエンティティ返却
    InventoryService->>InventoryRepo: findByProductId(商品ID)
    InventoryRepo->>DB: 在庫データ取得
    DB-->>InventoryRepo: 在庫データ返却
    InventoryRepo-->>InventoryService: Inventoryエンティティ返却
    InventoryService->>InventoryRepo: updateInventory(Inventory, 新在庫数)
    InventoryRepo->>DB: 在庫数更新
    DB-->>InventoryRepo: 更新結果返却
    InventoryRepo-->>InventoryService: 更新済みInventory返却
    InventoryService-->>InventoryController: 更新結果返却
    InventoryController-->>AdminBrowser: 更新結果JSON返却
</div>

   #### 3.2.4.4 商品のカテゴリ設定・変更機能
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant ProductController as ProductController
    participant ProductService as ProductService
    participant ProductRepo as ProductRepository
    participant CategoryRepo as CategoryRepository
    participant DB as データベース

    AdminUser->>AdminBrowser: 商品編集画面でカテゴリを選択
    AdminBrowser->>ProductController: PUT /api/admin/products/{商品ID}/category {カテゴリID}
    ProductController->>ProductService: updateProductCategory(商品ID, カテゴリID)
    ProductService->>ProductRepo: findById(商品ID)
    ProductRepo->>DB: 商品データ取得
    DB-->>ProductRepo: 商品データ返却
    ProductRepo-->>ProductService: Productエンティティ返却
    ProductService->>CategoryRepo: findById(カテゴリID)
    CategoryRepo->>DB: カテゴリデータ取得
    DB-->>CategoryRepo: カテゴリデータ返却
    CategoryRepo-->>ProductService: Categoryエンティティ返却
    ProductService->>ProductRepo: updateCategory(Product, Category)
    ProductRepo->>DB: 商品データ更新（カテゴリID変更）
    DB-->>ProductRepo: 更新結果返却
    ProductRepo-->>ProductService: 更新済みProduct返却
    ProductService-->>ProductController: 更新結果返却
    ProductController-->>AdminBrowser: 更新結果JSON返却
</div>

   #### 3.2.4.5 セール価格設定機能（期間限定価格）
   **1. セール価格設定機能**
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant ProductController as ProductController
    participant ProductService as ProductService
    participant ProductRepo as ProductRepository
    participant DB as データベース

    AdminUser->>AdminBrowser: 商品編集画面でセール価格・期間を入力
    AdminBrowser->>ProductController: PUT /api/admin/products/{商品ID}/sale {セール価格, 開始日, 終了日}
    ProductController->>ProductService: setSalePrice(商品ID, セール価格, 開始日, 終了日)
    ProductService->>ProductRepo: findById(商品ID)
    ProductRepo->>DB: 商品データ取得
    DB-->>ProductRepo: 商品データ返却
    ProductRepo-->>ProductService: Productエンティティ返却
    ProductService->>ProductRepo: updateSaleInfo(Product, セール価格, 開始日, 終了日)
    ProductRepo->>DB: 商品データ更新（セール情報）
    DB-->>ProductRepo: 更新結果返却
    ProductRepo-->>ProductService: 更新済みProduct返却
    ProductService-->>ProductController: 更新結果返却
    ProductController-->>AdminBrowser: 更新結果JSON返却
</div>

**2. セール価格表示機能**
<div class="mermaid">
sequenceDiagram
    participant User as ユーザー
    participant Browser as フロントエンド
    participant ProductController as ProductController
    participant ProductService as ProductService
    participant ProductRepo as ProductRepository
    participant DB as データベース

    User->>Browser: 商品詳細ページを開く
    Browser->>ProductController: GET /api/products/{商品ID}
    ProductController->>ProductService: getProductDetail(商品ID)
    ProductService->>ProductRepo: findById(商品ID)
    ProductRepo->>DB: 商品データ取得
    DB-->>ProductRepo: 商品データ返却
    ProductRepo-->>ProductService: Productエンティティ返却
    ProductService->>Product: isSaleNow()（現在時刻がセール期間内か判定）
    alt セール期間中
        ProductService->>Product: セール価格を取得
    else 通常期間
        ProductService->>Product: 通常価格を取得
    end
    ProductService-->>ProductController: 商品DTO（表示価格含む）返却
    ProductController-->>Browser: 商品情報JSON返却
    Browser-->>User: 商品詳細画面に価格を表示
</div>

   #### 3.2.4.6 商品情報の一括登録・編集機能
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant ProductBulkController as ProductBulkController
    participant ProductBulkService as ProductBulkService
    participant CSVParser as CSVParser
    participant ProductRepo as ProductRepository
    participant CategoryRepo as CategoryRepository
    participant InventoryRepo as InventoryRepository
    participant DB as データベース

    AdminUser->>AdminBrowser: 一括登録・編集画面でCSVファイル選択
    AdminBrowser->>ProductBulkController: POST /api/admin/products/bulk-upload {CSVファイル}
    ProductBulkController->>ProductBulkService: bulkRegisterOrUpdate(CSVファイル)
    ProductBulkService->>CSVParser: parse(CSVファイル)
    CSVParser-->>ProductBulkService: 商品データリスト返却

    loop CSV内全商品データ
        ProductBulkService->>ProductRepo: findByIdOrCode(商品IDまたは商品コード)
        ProductRepo->>DB: 商品データ取得
        DB-->>ProductRepo: 商品データ返却
        ProductRepo-->>ProductBulkService: Productエンティティ返却 or null

        ProductBulkService->>CategoryRepo: findByNameOrId(カテゴリ名またはID)
        CategoryRepo->>DB: カテゴリデータ取得
        DB-->>CategoryRepo: カテゴリデータ返却
        CategoryRepo-->>ProductBulkService: Categoryエンティティ返却

        alt 新規登録
            ProductBulkService->>ProductRepo: save(新規Productエンティティ)
            ProductRepo->>DB: 商品データ新規保存
            DB-->>ProductRepo: 保存結果返却
        else 既存編集
            ProductBulkService->>ProductRepo: update(既存Productエンティティ)
            ProductRepo->>DB: 商品データ更新
            DB-->>ProductRepo: 更新結果返却
        end

        ProductBulkService->>InventoryRepo: saveOrUpdate(在庫データ)
        InventoryRepo->>DB: 在庫データ保存・更新
        DB-->>InventoryRepo: 結果返却
    end

    ProductBulkService-->>ProductBulkController: 結果リスト返却（成功・失敗件数、エラー内容等）
    ProductBulkController-->>AdminBrowser: 結果JSON返却
</div>

   #### 3.2.4.7 商品情報の一括取得機能
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant ProductBulkController as ProductBulkController
    participant ProductBulkService as ProductBulkService
    participant ProductRepo as ProductRepository
    participant CategoryRepo as CategoryRepository
    participant InventoryRepo as InventoryRepository
    participant CSVExporter as CSVExporter
    participant DB as データベース

    AdminUser->>AdminBrowser: 一括エクスポート画面で「ダウンロード」押下
    AdminBrowser->>ProductBulkController: GET /api/admin/products/bulk-export?filter=XX
    ProductBulkController->>ProductBulkService: exportProducts(filter)
    ProductBulkService->>ProductRepo: findAllOrFiltered(filter)
    ProductRepo->>DB: 商品データ取得
    DB-->>ProductRepo: 商品データリスト返却
    ProductRepo-->>ProductBulkService: 商品エンティティリスト返却

    loop 商品ごと
        ProductBulkService->>CategoryRepo: findById(カテゴリID)
        CategoryRepo->>DB: カテゴリデータ取得
        DB-->>CategoryRepo: カテゴリデータ返却
        CategoryRepo-->>ProductBulkService: Categoryエンティティ返却

        ProductBulkService->>InventoryRepo: findByProductId(商品ID)
        InventoryRepo->>DB: 在庫データ取得
        DB-->>InventoryRepo: 在庫データ返却
        InventoryRepo-->>ProductBulkService: Inventoryエンティティ返却
    end

    ProductBulkService->>CSVExporter: exportToCSV(商品・カテゴリ・在庫リスト)
    CSVExporter-->>ProductBulkService: CSVファイル生成
    ProductBulkService-->>ProductBulkController: CSVファイル返却
    ProductBulkController-->>AdminBrowser: CSVファイルダウンロードレスポンス
</div>


  ### 3.2.5 注文管理機能（管理者向け）

   #### 3.2.5.1 注文一覧表示機能
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant Browser as 管理画面
    participant OrderController as OrderController
    participant OrderService as OrderService
    participant OrderRepo as OrderRepository
    participant UserRepo as UserRepository
    participant DB as データベース

    AdminUser->>Browser: 注文一覧画面を開く
    Browser->>OrderController: GET /api/admin/orders?filter=XX&page=1
    OrderController->>OrderService: getOrderList(filter, page)
    OrderService->>OrderRepo: findAllOrFiltered(filter, page)
    OrderRepo->>DB: 注文データ取得（検索条件・ページング適用）
    DB-->>OrderRepo: 注文データリスト返却
    OrderRepo-->>OrderService: 注文エンティティリスト返却

    loop 注文ごと
        OrderService->>UserRepo: findById(注文.ユーザーID)
        UserRepo->>DB: ユーザーデータ取得
        DB-->>UserRepo: ユーザーデータ返却
        UserRepo-->>OrderService: ユーザーエンティティ返却
    end

    OrderService-->>OrderController: 注文DTOリスト返却
    OrderController-->>Browser: 注文一覧JSON返却
    Browser-->>AdminUser: 注文一覧画面表示
</div>

   #### 3.2.5.2 注文内容詳細の確認機能
   <div class="mermaid">
sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant OrderController as OrderController
    participant OrderService as OrderService
    participant OrderRepo as OrderRepository
    participant OrderItemRepo as OrderItemRepository
    participant UserRepo as UserRepository
    participant ProductRepo as ProductRepository
    participant DB as データベース

    AdminUser->>AdminBrowser: 注文一覧画面で注文を選択
    AdminBrowser->>OrderController: GET /api/admin/orders/{注文ID}
    OrderController->>OrderService: getOrderDetail(注文ID)
    OrderService->>OrderRepo: findById(注文ID)
    OrderRepo->>DB: 注文データ取得
    DB-->>OrderRepo: 注文データ返却
    OrderRepo-->>OrderService: Orderエンティティ返却

    OrderService->>OrderItemRepo: findByOrderId(注文ID)
    OrderItemRepo->>DB: 注文商品データ取得
    DB-->>OrderItemRepo: 注文商品リスト返却
    OrderItemRepo-->>OrderService: OrderItemエンティティリスト返却

    OrderService->>UserRepo: findById(Order.ユーザーID)
    UserRepo->>DB: ユーザーデータ取得
    DB-->>UserRepo: ユーザーデータ返却
    UserRepo-->>OrderService: Userエンティティ返却

    loop 注文商品ごと
        OrderService->>ProductRepo: findById(OrderItem.商品ID)
        ProductRepo->>DB: 商品データ取得
        DB-->>ProductRepo: 商品データ返却
        ProductRepo-->>OrderService: Productエンティティ返却
    end

    OrderService-->>OrderController: 注文詳細DTO返却
    OrderController-->>AdminBrowser: 注文詳細JSON返却
    AdminBrowser-->>AdminUser: 注文詳細画面表示
</div>

   #### 3.2.5.3 発送ステータスの更新機能
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant OrderController as OrderController
    participant OrderService as OrderService
    participant OrderRepo as OrderRepository
    participant StatusHistoryRepo as OrderStatusHistoryRepository
    participant DB as データベース

    AdminUser->>AdminBrowser: 注文詳細画面でステータス変更
    AdminBrowser->>OrderController: PUT /api/admin/orders/{注文ID}/status {新ステータス}
    OrderController->>OrderService: updateShippingStatus(注文ID, 新ステータス, 操作ユーザー)
    OrderService->>OrderRepo: findById(注文ID)
    OrderRepo->>DB: 注文データ取得
    DB-->>OrderRepo: 注文データ返却
    OrderRepo-->>OrderService: Orderエンティティ返却
    OrderService->>Order: setShippingStatus(新ステータス)
    OrderService->>OrderRepo: save(Order)
    OrderRepo->>DB: 注文データ更新（ステータス変更）
    DB-->>OrderRepo: 更新結果返却
    OrderRepo-->>OrderService: 更新済みOrder返却
    alt 履歴記録が必要な場合
        OrderService->>StatusHistoryRepo: save(注文ID, 新ステータス, 操作ユーザー, 日時)
        StatusHistoryRepo->>DB: ステータス履歴保存
        DB-->>StatusHistoryRepo: 保存結果返却
        StatusHistoryRepo-->>OrderService: 保存済み履歴返却
    end
    OrderService-->>OrderController: 更新結果返却
    OrderController-->>AdminBrowser: 更新結果JSON返却
    AdminBrowser-->>AdminUser: 画面に反映・通知
</div>

   #### 3.2.5.4 注文データのCSVエクスポート機能
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant OrderExportController as OrderExportController
    participant OrderExportService as OrderExportService
    participant OrderRepo as OrderRepository
    participant OrderItemRepo as OrderItemRepository
    participant UserRepo as UserRepository
    participant CSVExporter as CSVExporter
    participant DB as データベース

    AdminUser->>AdminBrowser: エクスポート画面で条件指定・ダウンロード押下
    AdminBrowser->>OrderExportController: GET /api/admin/orders/export?filter=XX
    OrderExportController->>OrderExportService: exportOrdersToCSV(filter)
    OrderExportService->>OrderRepo: findAllOrFiltered(filter)
    OrderRepo->>DB: 注文データ取得
    DB-->>OrderRepo: 注文データリスト返却
    OrderRepo-->>OrderExportService: 注文エンティティリスト返却

    loop 注文ごと
        OrderExportService->>OrderItemRepo: findByOrderId(注文ID)
        OrderItemRepo->>DB: 注文商品データ取得
        DB-->>OrderItemRepo: 注文商品リスト返却
        OrderItemRepo-->>OrderExportService: OrderItemエンティティリスト返却

        OrderExportService->>UserRepo: findById(注文.ユーザーID)
        UserRepo->>DB: ユーザーデータ取得
        DB-->>UserRepo: ユーザーデータ返却
        UserRepo-->>OrderExportService: Userエンティティ返却
    end

    OrderExportService->>CSVExporter: exportToCSV(注文・商品・ユーザー情報)
    CSVExporter-->>OrderExportService: CSVファイル生成
    OrderExportService-->>OrderExportController: CSVファイル返却
    OrderExportController-->>AdminBrowser: CSVファイルダウンロードレスポンス
</div>


  ### 3.2.6 サイト運営機能（管理者向け）

   #### 3.2.6.1 管理画面ログイン機能
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant AdminAuthController as AdminAuthController
    participant AdminAuthService as AdminAuthService
    participant AdminUserRepo as AdminUserRepository
    participant PasswordHasher as PasswordHasher
    participant TokenProvider as TokenProvider
    participant DB as データベース

    AdminUser->>AdminBrowser: ログイン画面でID・パスワード入力
    AdminBrowser->>AdminAuthController: POST /api/admin/login {ID, パスワード}
    AdminAuthController->>AdminAuthService: authenticate(ID, パスワード)
    AdminAuthService->>AdminUserRepo: findByIdOrEmail(ID)
    AdminUserRepo->>DB: 管理者データ取得
    DB-->>AdminUserRepo: 管理者データ返却
    AdminUserRepo-->>AdminAuthService: AdminUserエンティティ返却
    AdminAuthService->>PasswordHasher: verify(入力パスワード, DBハッシュ)
    PasswordHasher-->>AdminAuthService: 検証結果
    alt 認証成功
        AdminAuthService->>TokenProvider: generateToken(AdminUser)
        TokenProvider-->>AdminAuthService: JWTトークン返却
        AdminAuthService-->>AdminAuthController: トークン・管理者情報返却
        AdminAuthController-->>AdminBrowser: ログイン成功レスポンス（トークン含む）
        AdminBrowser-->>AdminUser: 管理画面トップへ遷移
    else 認証失敗
        AdminAuthService-->>AdminAuthController: エラー返却
        AdminAuthController-->>AdminBrowser: ログイン失敗レスポンス
        AdminBrowser-->>AdminUser: エラー表示
    end
</div>

   #### 3.2.6.2 サイト基本情報登録・編集機能（会社概要、特商法表記、プライバシーポリシーなど）
   **1. サイト基本情報の登録・編集機能**
   <div class="mermaid">
   sequenceDiagram
    participant AdminUser as 管理者
    participant AdminBrowser as 管理画面
    participant SiteInfoController as SiteInfoController
    participant SiteInfoService as SiteInfoService
    participant SiteInfoRepo as SiteInfoRepository
    participant DB as データベース

    AdminUser->>AdminBrowser: サイト基本情報編集画面を開く
    AdminBrowser->>SiteInfoController: GET /api/admin/site-info
    SiteInfoController->>SiteInfoService: getSiteInfo()
    SiteInfoService->>SiteInfoRepo: findAll()
    SiteInfoRepo->>DB: サイト情報データ取得
    DB-->>SiteInfoRepo: サイト情報データ返却
    SiteInfoRepo-->>SiteInfoService: SiteInfoエンティティ返却
    SiteInfoService-->>SiteInfoController: サイト情報DTO返却
    SiteInfoController-->>AdminBrowser: サイト情報JSON返却

    AdminUser->>AdminBrowser: 情報を入力・編集し保存
    AdminBrowser->>SiteInfoController: POST /api/admin/site-info {会社概要, 特商法, プライバシーポリシー等}
    SiteInfoController->>SiteInfoService: saveOrUpdateSiteInfo(入力内容)
    SiteInfoService->>SiteInfoRepo: saveOrUpdate(入力内容)
    SiteInfoRepo->>DB: サイト情報データ保存・更新
    DB-->>SiteInfoRepo: 保存結果返却
    SiteInfoRepo-->>SiteInfoService: 更新済みSiteInfoエンティティ返却
    SiteInfoService-->>SiteInfoController: 更新結果返却
    SiteInfoController-->>AdminBrowser: 保存結果JSON返却
</div>

   **2. サイト基本情報の公開・表示機能**
   <div class="mermaid">
   sequenceDiagram
    participant User as 一般ユーザー
    participant Browser as 公開サイト
    participant SiteInfoController as SiteInfoController
    participant SiteInfoService as SiteInfoService
    participant SiteInfoRepo as SiteInfoRepository
    participant DB as データベース

    User->>Browser: サイトの会社概要ページ等を開く
    Browser->>SiteInfoController: GET /api/site-info
    SiteInfoController->>SiteInfoService: getSiteInfo()
    SiteInfoService->>SiteInfoRepo: findAll()
    SiteInfoRepo->>DB: サイト情報データ取得
    DB-->>SiteInfoRepo: サイト情報データ返却
    SiteInfoRepo-->>SiteInfoService: SiteInfoエンティティ返却
    SiteInfoService-->>SiteInfoController: サイト情報DTO返却
    SiteInfoController-->>Browser: サイト情報JSON返却
    Browser-->>User: サイト基本情報ページを表示
</div>

   #### 3.2.6.3 購入者からの問い合わせ受付機能（お問い合わせ受付フォーム）
   <div class="mermaid">
   sequenceDiagram
    participant User as 購入者
    participant Browser as フロントエンド
    participant InquiryController as InquiryController
    participant InquiryService as InquiryService
    participant InquiryRepo as InquiryRepository
    participant MailService as MailService
    participant DB as データベース
    participant MailServer as メールサーバ

    User->>Browser: お問い合わせフォーム入力・送信
    Browser->>InquiryController: POST /api/inquiry {氏名, メール, 件名, 内容}
    InquiryController->>InquiryService: receiveInquiry(フォーム内容)
    InquiryService->>InquiryRepo: save(問い合わせエンティティ)
    InquiryRepo->>DB: 問い合わせデータ保存
    DB-->>InquiryRepo: 保存結果返却
    InquiryRepo-->>InquiryService: 保存済みエンティティ返却
    InquiryService->>MailService: sendInquiryNotification(管理者宛, 問い合わせ内容)
    MailService->>MailServer: メール送信
    MailServer-->>MailService: 送信結果返却
    alt 自動返信あり
        InquiryService->>MailService: sendAutoReply(購入者宛, 受付完了メッセージ)
        MailService->>MailServer: メール送信
        MailServer-->>MailService: 送信結果返却
    end
    InquiryService-->>InquiryController: 受付完了返却
    InquiryController-->>Browser: 受付完了JSON返却
    Browser-->>User: 受付完了画面・メッセージ表示
</div>

**補足:**
 - バリデーション（必須項目、メール形式など）はInquiryServiceで実装。
 - スパム防止のためreCAPTCHAや簡易認証もInquiryControllerで導入可能。
 - 問い合わせ内容は管理画面から一覧・詳細表示・対応状況管理も可能（別途設計）。
 - メール送信は同期・非同期どちらでも可。大量の場合はジョブキューを利用。
 - 管理者宛メール・自動返信メールのテンプレートはMailServiceで管理。
 - 問い合わせ受付完了後、ユーザーに「受付完了画面」や「サンクスメール」を表示・送信。