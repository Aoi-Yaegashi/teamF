## 3. 機能設計（基本設計書の「3. 機能設計」に対応）
 ### 3.1 機能一覧
本システムが提供する機能は以下の通りである。

  #### 3.1.1 商品閲覧・購入機能（購入者向け）

   ##### 3.1.1.1 商品一覧・カテゴリ別の商品閲覧機能
   ###### 3.1.1.1.1 機能概要
     - ユーザーが商品カテゴリを選択し、該当カテゴリの商品を一覧表示できる。
     - 商品画像・商品名・価格などの主要情報を一覧で表示する。
   ###### 3.1.1.1.2 データ仕様
     - 商品テーブル：商品ID、商品名、価格、画像URL、カテゴリID、在庫数など
     - カテゴリテーブル：カテゴリID、カテゴリ名
   ###### 3.1.1.1.3 処理
     - 商品一覧取得処理（カテゴリID、検索キーワード、並び順、ページ番号をパラメータとして受け取り、該当商品のリストを返却する）を実行する。
     - カテゴリ選択時に再検索を実行する。

   ##### 3.1.1.2 商品詳細ページの表示機能
   ##### 3.1.1.2.1 機能概要
    - 商品一覧や検索結果から商品を選択した際、該当商品の詳細情報（写真、価格、説明、素材等）を画面に表示する。
   ##### 3.1.1.2.2 データ仕様
    - 商品テーブル：商品ID、商品名、価格、説明、素材、画像URL、在庫数
   ##### 3.1.1.2.3 処理
    - 商品IDをキーに、データベースから該当商品の詳細情報を取得する。
    - 商品が非公開・在庫切れの場合の表示制御を実施する。
    - 存在しない商品IDの場合は、エラーメッセージを表示する。
    - 非公開商品や販売終了商品の場合は、エラーメッセージを表示する。
    - 在庫切れ時は「在庫なし」を表示する。

   ##### 3.1.1.3 商品のカート追加／削除／数量変更機能
   ##### 3.1.1.3.1 機能概要
    - ユーザーが商品詳細画面や一覧画面から商品をカートに追加できる。
    - カート画面で商品の数量変更や削除ができる。
    - カート内容はセッションで保持される。
   ##### 3.1.1.3.2 データ仕様
    - カート（cart）：ユーザID、作成日時
    - カートアイテム（cart_item）：カートID、商品ID、数量
    - 商品情報：商品ID、商品名、価格、画像URL
   ##### 3.1.1.3.3 処理
    - 商品ID・数量・ユーザIDを受け取り、既存カートがあれば数量を加算、なければ新規追加する。
    - カート画面で数量入力欄を編集し「更新」ボタンで反映する。
    - カート画面の「削除」ボタンで該当商品をカートから除外する。
    - 在庫不足時はエラーメッセージを表示する。
   
   ##### 3.1.1.4 カート内商品の一覧、数量、小計、合計金額の表示機能
   ##### 3.1.1.4.1 機能概要
    - ユーザーのカートに入っている全商品の情報（商品名、画像、単価、数量、小計）を一覧表示する。
    - カート全体の合計金額を表示する。
    - 数量変更や商品削除操作時に即時反映される。
   ##### 3.1.1.4.2 データ仕様
    - カート（cart）：ユーザID、作成日時
    - カートアイテム（cart_item）：カートID、商品ID、数量
    - 商品情報：商品ID、商品名、価格、画像URL
   ##### 3.1.1.4.3 処理
    - ユーザIDまたはセッションIDを元にカート情報を取得する。
    - カートアイテムごとに商品情報を参照し、一覧データを生成する。
    - 「各カートアイテムの小計＝単価×数量」
    - 「合計金額＝全カートアイテムの小計合計」
    - 商品情報が取得できない場合は、エラーメッセージを表示する。
   
   ##### 3.1.1.5 注文確定処理機能
   ##### 3.1.1.5.1 機能概要
    - カート内商品の内容をもとに、ユーザーが注文を確定する処理を行う。
    - 在庫数のチェック・確保、注文データの登録、注文完了画面の表示、確認メールの送信までを一連で実施する。
   ##### 3.1.1.5.2 データ仕様
    - 注文テーブル（orders）：注文ID、ユーザID、注文日時、合計金額、配送先情報、ステータス
    - 注文明細テーブル（order_items）：注文ID、商品ID、数量、単価
    - 商品テーブル（products）：商品ID、在庫数
   ##### 3.1.1.5.3 処理
    - カート内容を取得する（ユーザIDまたはセッションIDでカート情報を取得）。
    - 在庫の確保・減算を実施する。
    - 注文データの登録を行う。
    - カート内容をクリアする。
    - 注文完了メールを送信する。
   
   ##### 3.1.1.6 注文完了後の確認メール自動送信機能
   ##### 3.1.1.6.1 機能概要
    - ーザーが注文確定操作を完了した時点で、注文内容を記載した確認メールを自動で送信する。
   ##### 3.1.1.6.2 データ仕様
    - 送信先メールアドレス（注文時に入力されたもの）
    - 注文情報（注文番号、商品名、数量、合計金額、配送先など）
    - メールテンプレート（件名・本文・差し込み項目）
   ##### 3.1.1.6.3 処理
    - 注文確定処理完了後、注文データをもとにメール本文を生成する。
    - 送信結果（成功／失敗）をログに記録する。

  #### 3.1.2 商品検索機能（購入者向け）
   
   ##### 3.1.2.1 単語検索機能（オプション）
   ##### 3.1.2.1.1 機能概要
    - ユーザーが検索窓に商品名や説明などのキーワードを入力し、該当する商品を一覧で表示する。
    - 検索結果は部分一致や表記揺れにも対応し、利便性を高める。
   ##### 3.1.2.1.2 データ仕様
    - 検索対象フィールド：商品名、商品説明、商品タグ、カテゴリ名など
    - 商品テーブル：商品ID、商品名、説明、タグ、カテゴリID
   ##### 3.1.2.1.3 処理
    - 検索フォームから送信されたキーワードを受け取り、指定フィールドで部分一致検索を実施する。
    - 表記揺れや類義語に対応する（必要に応じて）。

  #### 3.1.3 配送料金設定・計算機能（管理者向け）
  
   ##### 3.1.3.1 送料設定機能
   ##### 3.1.3.1.1 機能概要
    - 管理者が管理画面から送料ルールを登録・編集できる。
    - ユーザーの注文時に、設定されたルールに従って自動的に送料を計算・適用する。
   ##### 3.1.3.1.2 データ仕様
    - 送料設定テーブル：送料タイプ、金額、地域、重量、注文金額閾値、配送方法ID、適用期間など
    - 配送方法テーブル：配送方法名、説明、関連送料設定ID
   ##### 3.1.3.1.3 処理
    - 管理者が送料ルールを登録・編集・削除できる。
    - 注文時に、カート内容・配送先情報・注文金額・重量などをもとに適用ルールを判定し、送料を自動計算する。
  
   ##### 3.1.3.2 配送方法の表示・選択機能
   ##### 3.1.3.2.1 機能概要
    - 管理者が管理画面から配送方法（例：宅配便、メール便、店舗受取など）を登録・編集・削除できる。
   ##### 3.1.3.2.2 データ仕様
    - 配送方法テーブル：配送方法ID、名称、説明、送料設定ID、利用条件、表示順、利用可否フラグ、目安日数など
   ##### 3.1.3.2.3 処理
    - 管理者が配送方法の登録・編集・削除を行う。

  #### 3.1.4 商品管理機能（管理者向け）
  
   ##### 3.1.4.1 商品登録・編集機能（商品名・価格・説明・画像など）
   ##### 3.1.4.1.1 機能概要
    - 管理者が管理画面から新規商品を登録し、既存商品の情報を編集できる。
   ##### 3.1.4.1.2 データ仕様
    - 商品テーブル：商品ID、商品名、価格、説明、画像URL、在庫数、カテゴリIDなど
    - 画像ファイル：JPEG/PNG対応、推奨サイズ・容量制限
   ##### 3.1.4.1.3 処理
    - 新規登録：入力フォームから商品情報を受け取り、バリデーション後にDBへ登録する。
    - 編集：既存商品の情報を取得し、編集内容をバリデーション後にDBへ反映する。
    - 公開/非公開切り替え：商品ごとに表示可否を設定できる。
    - 画像アップロード：ファイル形式・サイズチェック、サーバ保存、画像URL生成
   
   ##### 3.1.4.2 商品削除機能
   ##### 3.1.4.2.1 機能概要
    - 管理者が管理画面から商品を削除できる。
   ##### 3.1.4.2.2 データ仕様
    - 商品テーブル：商品ID
   ##### 3.1.4.2.3 処理
    - 商品IDを指定して削除処理を実行する。
   
   ##### 3.1.4.3 商品の在庫管理機能（在庫数の更新）
   ##### 3.1.4.3.1 機能概要
    - 管理者が管理画面から各商品の在庫数を登録・編集できる。
   ##### 3.1.4.3.2 データ仕様
    - 商品テーブル：商品ID、在庫数、最終更新日時、最終更新者ID
    - 在庫履歴テーブル：商品ID、変更前在庫数、変更後在庫数、変更理由、変更日時、担当者ID
   ##### 3.1.4.3.3 処理
    - 管理者が在庫数の手動更新を行う。
    - 注文確定時に在庫数を自動で減算する。
    - 入荷・出荷登録から在庫数の増減を実施する（オプション）。
   
   ##### 3.1.4.4 商品のカテゴリ設定・変更機能
   ##### 3.1.4.4.1 機能概要
    - 管理者が管理画面から商品にカテゴリを設定・変更できる。
    - 商品は1つ以上のカテゴリに所属できる。
    - カテゴリの新規作成・編集・削除は管理画面から行う。
   ##### 3.1.4.4.2 データ仕様
    - 商品テーブル：商品ID、カテゴリID（単一の場合）またはカテゴリIDリスト（複数対応の場合）
    - カテゴリテーブル：カテゴリID、カテゴリ名、親カテゴリID（階層構造対応の場合）、表示順、説明
   ##### 3.1.4.4.3 処理
    - 商品登録・編集時にカテゴリ選択内容をDBに保存する。
    - カテゴリの追加・編集を行う。
   
   ##### 3.1.4.5 セール価格設定機能（期間限定価格）
   ##### 3.1.4.5.1 機能概要
    - 管理者が管理画面から商品ごとにセール価格や割引率、セール期間を設定できる。
    - 設定した期間中、ユーザーには割引後価格と割引前価格（通常価格）が表示される。
    - セール期間外は自動的に通常価格に戻る。
   ##### 3.1.4.5.2 データ仕様
    - 商品テーブル：商品ID、通常価格、セール価格、割引率、セール開始日、セール終了日
    - 割引前価格（通常価格）と割引後価格（セール価格）の両方を保持
    - 割引率は自動計算または手動入力
   ##### 3.1.4.5.3 処理
    - セール期間中のみセール価格・割引率をフロントに表示する。
    - セール期間外は自動的に通常価格表示へ切り替える。
    - セール価格未設定時は通常価格を適用する。
   
   ##### 3.1.4.6 商品情報の一括登録・編集機能
   ##### 3.1.4.6.1 機能概要
    - 管理者がCSVファイル等を使い、複数の商品情報を一度に登録・編集できる。
   ##### 3.1.4.6.2 データ仕様
    - 商品テーブル：商品ID、商品名、価格、説明、画像URL、在庫数、カテゴリIDなど
   ##### 3.1.4.6.3 処理
    - CSVファイルをアップロードし、サーバー側でパース・バリデーション
    - 正常データはDBに一括登録・更新
   
   ##### 3.1.4.7 商品情報の一括取得機能
   ##### 3.1.4.7.1 機能概要
    - 管理者や外部システムが、指定条件に合致する複数の商品情報を一括で取得できる。
   ##### 3.1.4.7.2 データ仕様
    - 商品テーブル：商品ID、商品名、価格、説明、画像URL、在庫数、カテゴリIDなど
   ##### 3.1.4.7.3 処理
    - 指定された条件で商品データを検索・抽出する。
    - データを選択したフォーマット（CSV/JSON/XML）でエクスポートする。

  #### 3.1.5 注文管理機能（管理者向け）
   
   ##### 3.1.5.1 注文一覧表示機能
   ##### 3.1.5.1.1 機能概要
    - 管理者が注文情報を一元管理し、注文状況の確認・修正・キャンセル・エクスポートなどを行う。
    - 注文の受付から出荷・配送・完了・キャンセルまでのステータスを管理する。
   ##### 3.1.5.1.2 データ仕様
    - 注文テーブル：注文ID、顧客ID、注文日時、合計金額、ステータス、支払い方法、配送方法、配送先情報、注文メモ
    - 注文明細テーブル：注文ID、商品ID、数量、単価、合計金額
    - ステータス履歴テーブル：注文ID、変更前ステータス、変更後ステータス、変更日時、担当者ID
   ##### 3.1.5.1.3 処理
    - 注文情報の取得・一覧化・詳細表示
   
   ##### 3.1.5.2 注文内容詳細の確認機能
   ##### 3.1.5.2.1 機能概要
    - 管理者や購入者が、注文ごとに商品の明細・金額・注文者情報・配送先・決済方法・注文ステータスなどの詳細を確認できる。
   ##### 3.1.5.2.2 データ仕様
    - 注文テーブル：注文ID、注文日時、顧客ID、合計金額、ステータス、決済方法、配送方法、配送先情報、備考
    - 注文明細テーブル：注文ID、商品ID、商品名、数量、単価、小計
    - 顧客テーブル：顧客ID、氏名、連絡先
   ##### 3.1.5.2.3 処理
    - 指定注文IDで注文情報・明細・顧客情報・配送情報を取得し、画面に表示する。
    - 管理者は顧客検索から注文履歴を一覧・詳細確認できる。
   
   ##### 3.1.5.3 発送ステータスの更新機能
   ##### 3.1.5.3.1 機能概要
    - 管理者が注文ごとに発送ステータス（例：未発送→発送済み）を更新できる。
    - 送り状番号・発送日・到着予定日などの配送情報も同時に登録・編集できる。
   ##### 3.1.5.3.2 データ仕様
    - 注文テーブル：注文ID、発送ステータス、送り状番号、発送日、到着予定日、配送会社、最終更新日時、最終更新者ID
   ##### 3.1.5.3.3 処理
    - 管理者が発送ステータスを「発送済み」に変更する。
    - 送り状番号・発送日・到着予定日を入力・保存する。
   
   ##### 3.1.5.4 注文データのCSVエクスポート機能
   ##### 3.1.5.4.1 機能概要
    - 管理者が注文情報（注文番号、顧客情報、商品明細、金額、ステータス、配送先など）をCSV形式で一括ダウンロードできる。
   ##### 3.1.5.4.2 データ仕様
    - 注文テーブル：注文ID、注文日、顧客ID、合計金額、ステータス、決済方法、配送先情報など
    - 注文明細テーブル：注文ID、商品ID、商品名、数量、単価、小計
    - 顧客テーブル：顧客ID、氏名、住所、電話番号、メールアドレス
   ##### 3.1.5.4.3 処理
    - 指定された条件で注文データを検索・抽出する。
    - 選択したテンプレートに従い、必要な項目のみをCSV形式で出力する。

  #### 3.1.6 サイト運営機能（管理者向け）
   
   ##### 3.1.6.1 管理画面ログイン機能
   ##### 3.1.6.1.1 機能概要
    - 管理者がID・パスワードを入力し、認証に成功した場合のみ管理画面へアクセスできる。
   ##### 3.1.6.1.2 データ仕様
    - 管理者テーブル：管理者ID、ログインID、ハッシュ化パスワード、アカウント状態（有効/無効）、最終ログイン日時、ログイン失敗回数など
    - ログイン履歴テーブル：入力ログインID、ログイン結果、ログイン時間、IPアドレス、ユーザーエージェント
   ##### 3.1.6.1.3 処理
    - 入力ID・パスワードを受け取り、DBのハッシュ化パスワードと照合する。
    - 認証成功時、セッション開始・管理画面TOPへ遷移する。
    - 認証失敗時、エラーメッセージ表示・失敗回数を記録する。
    - 一定回数以上の失敗でアカウントロックを実行する。
   
   ##### 3.1.6.2 サイト基本情報登録・編集機能（会社概要、特商法表記、プライバシーポリシーなど）
   ##### 3.1.6.2.1 機能概要
    - 管理者が管理画面からサイトの基本情報を登録・編集できる。
    - 変更内容は即時または「保存して公開」操作でWebサイト全体に反映される。
   ##### 3.1.6.2.2 データ仕様
    - サイト設定テーブル：サイト名、最終更新日時、更新者IDなど
   ##### 3.1.6.2.3 処理
    - 入力値をバリデーションし、問題なければデータベースに保存する。
    - 「保存して公開」操作で全ページに反映する。
    - 画像アップロード時はファイル形式・サイズをチェックし、サーバーに保存する。
    - 変更履歴の記録（いつ・誰が・どの項目を変更したか）を行う。
   
   ##### 3.1.6.3 購入者からの問い合わせ受付機能（お問い合わせ受付フォーム）
   ##### 3.1.6.3.1 機能概要
    - 購入者がWebサイト上のフォームから問い合わせ内容を送信できる。
    - 入力内容は管理者に通知され、管理画面やメールで確認・管理できる。
   ##### 3.1.6.3.2 データ仕様
    - 問い合わせテーブル：問い合わせID、氏名、メールアドレス、電話番号、問い合わせ種別、内容、受付日時、対応状況など
   ##### 3.1.6.3.3 処理
    - 入力値のバリデーション（必須項目、メール形式、文字数制限など）を実施する（オプション）。
    - 送信時、問い合わせ内容をDBに保存し、管理者へメールで通知する。
    - 自動返信メール（受付完了通知）を購入者に送信する（オプション）。
    - 管理画面で問い合わせ内容の一覧・詳細・対応状況を管理する。