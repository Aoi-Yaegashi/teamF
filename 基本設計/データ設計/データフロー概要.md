### 5.3. データフロー概要

---

### 1. 商品一覧表示処理のデータフロー

1. **画面 (F02 商品一覧ページ)**  
   ユーザーがカテゴリや検索条件を指定して商品一覧を表示要求。  
2. **アプリケーション (Backend)**  
   条件を受け取り、`PRODUCT`、`CATEGORY`、`SALE_PRICE`テーブルを参照し、現在有効なセール価格を適用して商品一覧を取得。  
3. **データベース (DB)**  
   `PRODUCT`、`CATEGORY`、`SALE_PRICE`を結合して該当商品情報を取得。  
4. **アプリケーション (Backend)**  
   通常価格とセール価格を比較し、画面表示用に整形。  
5. **画面 (F02 商品一覧ページ)**  
   商品一覧を表示（セール価格がある商品は強調表示）。

---

### 2. 商品詳細表示処理のデータフロー

1. **画面 (F03 商品詳細ページ)**  
   ユーザーが商品を選択し、詳細表示要求を送信。  
2. **アプリケーション (Backend)**  
   商品IDをもとに`PRODUCT`および`SALE_PRICE`から現在の価格情報を取得。  
3. **データベース (DB)**  
   `PRODUCT`および有効な`SALE_PRICE`を参照。  
4. **アプリケーション (Backend)**  
   通常価格とセール価格を適用し、表示用に整形。  
5. **画面 (F03 商品詳細ページ)**  
   商品詳細を表示（セール価格が有効な場合はセール価格を表示）。

---

### 3. カート操作処理のデータフロー

1. **画面 (F04 カートページ)**  
   ユーザーが商品をカートに追加・削除・数量変更を実施。  
2. **アプリケーション (Backend)**  
   セッショントークンと商品IDをもとに、該当商品の現在価格（セール適用含む）を取得し、カート内容を更新。  
3. **データベース (DB)**  
   `CART`・`CART_ITEM`を更新。必要に応じて`PRODUCT`・`SALE_PRICE`を参照。  
4. **アプリケーション (Backend)**  
   セール価格を考慮してカート金額を算出し、表示用に整形。  
5. **画面 (F04 カートページ)**  
   カートの最新内容と価格を表示（セール価格適用済み）。

---

### 4. 注文処理のデータフロー

1. **画面 (F05 購入手続きページ)**  
   ユーザーが配送情報を入力し、注文確定を実行。  
2. **アプリケーション (Backend)**  
   カート内容と入力情報を受け取り、各商品の現在価格（セール含む）を参照。  
3. **アプリケーション (Backend)**  
   `ORDER`テーブルへ新規注文を作成し、`ORDER_ITEM`には価格を確定して記録。`SHIPPING_INFO`も登録。  
4. **データベース (DB)**  
   `ORDER`、`ORDER_ITEM`、`SHIPPING_INFO`へレコードを登録。  
5. **アプリケーション (Backend)**  
   注文完了メールを作成・送信。  
6. **画面 (F06 購入完了ページ)**  
   注文完了メッセージを表示。

---

### 5. 注文ステータス履歴管理のデータフロー

1. **アプリケーション (Backend)**  
   注文ステータスが変更されたタイミングで、`ORDER_STATUS_HISTORY`に履歴を登録。  
2. **データベース (DB)**  
   `ORDER_STATUS_HISTORY`に履歴を追加。  
3. **管理画面**  
   管理者がステータス履歴を確認可能。

---

### 6. 静的ページ管理と表示のデータフロー

1. **管理画面**  
   管理者が`PAGE_CONTENT`テーブルにページデータを登録・編集。  
2. **データベース (DB)**  
   `PAGE_CONTENT`のレコードが更新される。  
3. **画面 (F08 利用規約等ページ)**  
   表示要求に応じてデータを取得・表示。

---

### 7. 管理者ログイン処理のデータフロー

1. **画面 (管理者ログイン画面)**  
   管理者が認証情報を入力。  
2. **アプリケーション (Backend)**  
   入力されたユーザー名・パスワードを受け取り、認証処理を実施。  
3. **データベース (DB)**  
   `ADMIN_USER`の情報と照合し、認証を行う。  
4. **アプリケーション (Backend)**  
   成功時はログイントークンを返却。  
5. **画面 (管理者ログイン画面)**  
   成功時は管理画面へ遷移、失敗時はエラー表示。

---

### 8. カートのセッション管理処理のデータフロー

1. **画面 (全ページ)**  
   初回訪問時にセッショントークンを生成しCookieに保存。  
2. **アプリケーション (Backend)**  
   セッショントークンをもとに、`CART`の取得または作成を行う。  
3. **データベース (DB)**  
   `CART`がセッション単位で管理される。  
4. **画面 (各商品・カートページ)**  
   カート情報をもとに商品・価格情報（セール含む）を表示。

---

### 備考

- `SalePrice`は、`PRODUCT`に対して有効期間付きのセール価格を提供。  
- セール価格が有効な場合はそちらを優先して表示・注文処理に反映。  
- セール期間の判定は、`start_date <= 現在時刻 <= end_date`。  
-  将来的な会員機能や決済連携が導入される場合、データフローの拡張が必要。


