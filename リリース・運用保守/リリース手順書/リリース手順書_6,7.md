## 6. ロールバック手順

**6.1 ロールバック判断基準**

以下のいずれかの状況が発生し、ポストリリース確認担当者および作業担当者が15分以内での解決が困難と判断した場合、リリース責任者 (氏名A) がロールバックを決定する。

- アプリケーションが起動しない、または起動後すぐに停止する。
- 主要機能（商品表示、カート、注文、管理）が全く動作しない、エラーが頻発する、または性能が極端に劣化する。
- データの不整合や破損が発生している。
- システムのパフォーマンスが著しく劣化し、サービス提供に支障をきたす。
- 予期せぬ重大なセキュリティ上の問題が発見された。

**6.2 ロールバック作業手順**

| No | 手順                                                         | 担当者     | 確認者     | チェック | 備考/コマンド例 (環境に合わせて要変更)                                                                                                                                  |
| :-: | :----------------------------------------------------------- | :--------- | :--------- | :------: | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1  | **ロールバック開始宣言** | 責任者A    | 全員       |    [ ]   |                                                                                                                                                                         |
| 2  | **サービス停止 (再確認)** | Infra担当C | 責任者A    |    [ ]   | サービスが再開されていた場合、再度停止する (手順5.1, 5.2参照)。                                                                                                          |
| 3  | **新バージョン アプリケーション停止** | App担当B   | 確認担当D  |    [ ]   | 手順5.3 参照。                                                                                                                                                          |
| 4  | **新バージョンJARファイル退避** | App担当B   | 確認担当D  |    [ ]   | `mv /path/to/app/raffinehome-1.0.0.jar /path/to/rollback_artifacts/` <br> `rm /path/to/app/raffinehome-current.jar` (シンボリックリンクの場合)                          |
| 5  | **旧バージョンJARファイル復元** | App担当B   | 確認担当D  |    [ ]   | 手順5.4でバックアップした旧バージョンJARを戻す。<br> `cp /path/to/app_backup/raffinehome-vX.Y.Z_YYYYMMDDHHMM.jar /path/to/app/raffinehome-vX.Y.Z.jar` <br> `ln -sfn raffinehome-vX.Y.Z.jar /path/to/app/raffinehome-current.jar` |
| 6  | **【条件分岐】DBスキーマ変更を行ったか？** | 責任者A    | 全員       |    [ ]   | 今回(v1.0.0)は通常 No。Yesの場合は手順7へ。Noの場合は手順8へ。                                                                                                        |
| 7  | **データベースリストア (またはロールバックSQL実行)** | Infra担当C | App担当B   |    [ ]   | 事前取得したバックアップからリストア or ロールバック用SQLを実行。リストア手順はDB運用手順書参照。                                                                           |
| 8  | **旧バージョン アプリケーション起動** | App担当B   | 確認担当D  |    [ ]   | 手順5.8, 5.9, 5.10 参照。起動するJARは旧バージョン。                                                                                                                 |
| 9  | **旧バージョン 動作確認** | 確認担当D  | App担当B   |    [ ]   | 手順5.11, 5.12, 5.13 の主要項目を実施し、リリース前の状態に戻っていることを確認。                                                                                         |
| 10 | **サービス再開 (告知)** | Infra担当C | 責任者A    |    [ ]   | 手順5.15, 5.16 参照。ロールバックが完了し、旧バージョンでサービス再開した旨を告知。                                                                                       |
| 11 | **ロールバック完了報告** | 責任者A    | 全員       |    [ ]   | 関係者にロールバックが完了したことを報告。上記までを3時間以内を目安に実行する。                                                                                                                              |

## 7. 作業完了後の対応

- **監視再開**: [ ] (担当: Infra担当C) 一時停止していた監視アラートを有効に戻す。
- **リリース結果報告**: [ ] (担当: 責任者A) リリース作業の結果（成功/ロールバック）、所要時間、発生した問題点などをまとめ、関係者に報告する。
- **振り返り**: [ ] (担当: 全員参加) リリース作業に関する振り返りミーティングを実施し、今回の反省点や改善点を次回リリースに活かす。
