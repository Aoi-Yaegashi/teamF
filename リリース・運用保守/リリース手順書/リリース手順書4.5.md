## 4. 事前準備・確認事項

リリース作業開始前に、以下の項目が完了していることを確認します。チェックボックスにチェックを入れてください。

- [ ] リリース判定会議で、本リリースの実施が承認されていること。
- [ ] 関係部署およびユーザーへのリリース日時、サービス停止時間の告知が完了していること。
- [ ] **リリース対象ファイル**:
  - [ ] `raffinehome-1.0.0.jar` ファイルがビルドされ、指定のリリース用ディレクトリ (`/path/to/release/artifacts/`) に配置されていること。
  - [ ] ファイルのチェックサム（md5sum/sha256sumなど）が開発時のものと一致することを確認。
- [ ] **本番用設定ファイル**:
  - [ ] 本番サーバーの `/path/to/config/` ディレクトリに `application-prod.properties` が配置されていること。
  - [ ] `application-prod.properties` 内の以下の設定値が本番環境用に正しく設定されていることを確認。
    - `server.port=8080` (または本番用ポート)
    - `spring.datasource.url=jdbc:mysql://<本番DBホスト>:<ポート>/zakkadb` (DBの種類、ホスト、ポート、DB名)
    - `spring.datasource.username=<本番DBユーザー>`
    - `spring.datasource.password=<本番DBパスワード>`
    - `spring.jpa.hibernate.ddl-auto=validate` (または `none`) **※`update`や`create`でないこと！**
    - `logging.level.com.example.raffinehome=INFO` (または `WARN`)
    - その他、環境依存の設定項目
- [ ] **データベース**:
  - [ ] 本番データベース (`raffinedb`) が作成済みであること。
  - [ ] 本番データベースのスキーマ（テーブル定義）が、アプリケーション（`@Entity`定義）が要求するものと一致していること。(`ddl-auto=validate` で起動時に検証される)
  - [ ] **【重要】** 本番データベース全体のバックアップが取得されていること。
    - 取得日時: `2025年07月28日 14:00`
    - バックアップ方法: (例: mysqldump コマンド, クラウドDBのスナップショット機能)
    - バックアップファイルの保管場所: `/path/to/db_backup/raffinedb_20250728_1400.sql.gz`
- [ ] **現行バージョンバックアップ**: (初回リリース時は不要)
  - [ ] 現在本番で稼働中の `raffinehome-current.jar` (または旧バージョンJAR) がバックアップされていること。
    - バックアップ場所: `/path/to/app_backup/raffinehome-vX.Y.Z.jar`
- [ ] **ロールバック手順**:
  - [ ] 本手順書内の「6. ロールバック手順」の内容が最終確認されていること。
  - [ ] ロールバックに必要な旧バージョンのJARファイルとDBバックアップが利用可能であること。
- [ ] **監視ツール**:
  - [ ] リリース作業中の誤報を防ぐため、対象サーバー/アプリケーションに関する監視アラートを一時的に停止する。(担当: インフラ担当 C)

**事前準備完了確認**: リリース責任者 (責任者A) `2025年07月29日 12:00`

## 5. リリース作業手順

**【作業開始】** `2025年07月29日 13:00` (予定) - 責任者 (責任者A) が宣言
優輝
| No | 手順                                                               | 担当者     | 確認者     | チェック | 備考/コマンド例 (環境に合わせて要変更)                                                                                                                                                                                                |
| :-: | :----------------------------------------------------------------- | :--------- | :--------- | :------: | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1  | **サービス停止 (告知)** | Infra担当C | 責任者A    |    [ ]   | `raffinehome`は短時間停止想定。メンテナンス画面等あれば表示。ユーザーへの作業開始告知。 |
| 2  | **ロードバランサーから切り離し** | Infra担当C | 作業担当B  |    [ ]   | ※複数台構成の場合                                                                                                                                                                                               |
| 3  | **アプリケーション停止** | App担当B   | 確認担当D  |    [ ]   | サーバーログイン: `ssh user@your-server-ip` <br> プロセス確認: `ps aux \| grep raffinehome` <br> プロセス停止: `kill <プロセスID>` <br> 停止再確認: `ps aux \| grep raffinehome` (何も表示されない)                     |
| 4  | **現行バージョンJARバックアップ** | App担当B   | 確認担当D  |    [ ]   | 初回リリース時はスキップ。`mv /path/to/app/raffinehome-current.jar /path/to/app_backup/raffinehome-vX.Y.Z_$(date +%Y%m%d%H%M).jar`                                                                      |
| 5  | **新バージョンJAR配置** | App担当B   | 確認担当D  |    [ ]   | `cp /path/to/release/artifacts/raffinehome-1.0.0.jar /path/to/app/raffinehome-1.0.0.jar` <br> `ln -sfn raffinehome-1.0.0.jar /path/to/app/raffinehome-current.jar` (シンボリックリンク運用の場合)              |
| 6  | **ファイル整合性確認** | App担当B   | 確認担当D  |    [ ]   | `md5sum /path/to/app/raffinehome-1.0.0.jar` (事前準備時のチェックサムと比較)                                                                                                                               |
| 7  | **設定ファイル確認** | App担当B   | 確認担当D  |    [ ]   | `/path/to/config/application-prod.properties` の内容を再確認 (目視、diffコマンド等)                                                                                                                            |
| 8  | **アプリケーション起動** | App担当B   | 確認担当D  |    [ ]   | `cd /path/to/app` <br> `nohup java -jar raffinehome-current.jar --spring.profiles.active=prod > /path/to/logs/app_$(date +%Y%m%d%H%M).log 2>&1 &`                                                                |
| 9  | **起動ログ確認** | App担当B   | 確認担当D  |    [ ]   | `tail -f /path/to/logs/app_YYYYMMDDHHMM.log` で監視。<br> `Started RaffinehomeApplication in ... seconds` が表示され、`ERROR` ログがないことを確認。Hibernateのスキーマ検証 (`ddl-auto=validate`) エラーがないかも確認。 |
| 10 | **プロセス確認** | App担当B   | 確認担当D  |    [ ]   | `ps aux \| grep raffinehome` でJavaプロセスが起動していることを確認。                                                                                                                                            |
| 11 | **ポストリリース確認 (基本動作)** | 確認担当D  | App担当B   |    [ ]   | 1. ブラウザで `http://<サーバーIP>:8080/` にアクセスし、トップページが表示されること。 <br> 2. API `/api/products` にアクセスし、商品一覧がJSONで返却されること (Postman等でも可)。 <br> 3. 商品詳細ページの表示。                                 |
| 12 | **ポストリリース確認 (主要機能)** | 確認担当D  | App担当B   |    [ ]   | 1. 商品をカートに追加できること。 <br> 2. カート内容が表示・更新・削除できること。 <br> 3. テストユーザー情報で注文を行い、注文完了画面が表示されること。 <br> 4. 本番DBの `orders`, `order_details` テーブルに注文データが記録されていること。 |
| 13 | **ポストリリース確認 (ログ)** | 確認担当D  | App担当B   |    [ ]   | アプリケーションログ (`/path/to/logs/app_YYYYMMDDHHMM.log`) にエラーが出ていないことを再度確認。                                                                                                               |
| 14 | **ポストリリース確認 (監視)** | Infra担当C | 責任者A    |    [ ]   | 監視ツールでCPU、メモリ、応答時間等に異常値がないことを確認。                                                                                                                                              |
| 15 | **ロードバランサーへ組み込み** | Infra担当C | 作業担当B  |    [ ]   | ※複数台構成の場合                                                                                                                                                                                               |
| 16 | **サービス再開 (告知)** | Infra担当C | 責任者A    |    [ ]   | メンテナンス画面解除など。ユーザーへの作業完了告知。                                                                                                                                                           |
